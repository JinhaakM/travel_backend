/**
 * 
 */


   // 객체 초기화
var IMP = window.IMP;
IMP.init("imp87501644");

function requestPay() {
  // 결제창 호출      
  IMP.request_pay(
    {
      // 파라미터 값 설정 
      pg: "kakaopay",
      pay_method: "kakaopay",
      merchant_uid: "57008833-33027", // 상점 고유 주문번호. 계속 변경되어야 함.
      name: "travel 구독",
      amount: 9900,
      buyer_email: "good@portone.io",
      buyer_name: "포트원 기술지원팀",
      buyer_tel: "010-1234-5678",
      buyer_addr: "서울특별시 강남구 삼성동",
      buyer_postcode: "123-456",
    },
    async requestPayResponse => {
      const { success, error_msg } = requestPayResponse;
      if (!success) {
        alert(`결제에 실패하였습니다. 에러 내용: ${error_msg}`);
        return;
      } else {
        alert(`결제에 성공하였습니다.`);
      }
    }
  );
}

      
      app.use(bodyParser.json());
app.post("/payments/complete", async (req, res) => {
  try {
    // req의 body에서 imp_uid, merchant_uid 추출
    const { imp_uid, merchant_uid } = req.body;
    
    // 액세스 토큰(access token) 발급 받기
    const getToken = await axios({
      url: "https://api.iamport.kr/users/getToken",
      method: "post", // POST method
      headers: { "Content-Type": "application/json" },
      data: {
        imp_key: "imp_apikey", // REST API 키
        imp_secret: "ekKoeW8RyKuT0zgaZsUtXXTLQ4AhPFW3ZGseDA6bkA5lamv9OqDMnxyeB9wqOsuO9W3Mx9YSJ4dTqJ3f" // REST API Secret
      }
    });
const { access_token } = getToken.data; // 인증 토큰
    
// imp_uid로 포트원 서버에서 결제 정보 조회
const getPaymentData = await axios({
  // imp_uid 전달
  url: `https://api.iamport.kr/payments/${imp_uid}`,
  // GET method
  method: "get",
  // 인증 토큰 Authorization header에 추가
  headers: { "Authorization": access_token }
});
const paymentData = getPaymentData.data.response; // 조회한 결제 정보
    
  } catch (e) {
  res.status(400).send(e);
}
});